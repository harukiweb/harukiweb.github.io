<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>浜松市避難所マップ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
  </style>
</head>
<body>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <div id="map"></div>

<script>
  const map = L.map('map').setView([34.7101, 137.7265], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // カスタムアイコン
  const redIcon = new L.Icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', iconSize: [32, 32] });
  const blueIcon = new L.Icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', iconSize: [32, 32] });
  const yellowIcon = new L.Icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png', iconSize: [32, 32] });

  let userLat, userLng;

  navigator.geolocation.getCurrentPosition(pos => {
    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;


    // 現在地マーカー（赤）
    L.marker([userLat, userLng], { icon: redIcon }).addTo(map).bindPopup("あなたの現在地").openPopup();

    // 避難所CSV読み込み
    Papa.parse("hinanjo.csv", {
      download: true,
      header: true,
      complete: function(results) {
        const shelters = [];

        results.data.forEach(row => {
          const lat = parseFloat(row["緯度"]);
          const lng = parseFloat(row["経度"]);
          if (!isNaN(lat) && !isNaN(lng)) {
            const name = row["避難所名称"];
            const address = row["所在地"];
            const distance = getDistance(userLat, userLng, lat, lng);

            shelters.push({ lat, lng, name, address, distance });
          }
        });

        // 最寄り避難所を特定
        shelters.sort((a, b) => a.distance - b.distance);
        const nearest = shelters[0];

        shelters.forEach(shelter => {
          const icon = (shelter === nearest) ? blueIcon : yellowIcon;
          const googleMapsURL = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${shelter.lat},${shelter.lng}&travelmode=walking`;

          L.marker([shelter.lat, shelter.lng], { icon }).addTo(map)
            .bindPopup(`<strong>${shelter.name}</strong><br>${shelter.address}<br><a href="${googleMapsURL}" target="_blank">Google Mapsで避難経路</a>`);
        });
      }
    });
  });

  // 距離計算（Haversine式）
  function getDistance(lat1, lng1, lat2, lng2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }
</script>
</body>
</html>
